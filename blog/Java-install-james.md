# 前提工作

## 下载Apache James Server

[Apache James Download](http://james.apache.org/download.cgi#Apache_James_Server)

我下载的是Binary (Unix TAR): james-binary-2.3.2.1.tar.gz

## 配置JAVA_HOME环境变量

James运行的时候需要这个变量调用JDK的东西

在/etc/profile加上下面的东西

```shell
export JAVA_HOME=/path/to/jdk
export PATH=$JAVA_HOME/bin:$PATH
export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar
```

下面的东西需要root用户执行, 所以切换到root用户

```shell
$ sudo su root
# source /etc/profile
```

## 检查25端口

安装james服务器smtp会占用25端口, 所以不能被其他程序占用25端口

```shell
# lsof -i:25
```

如果没东西显示进行下一步, 如果有程序在占用就kill掉



# 安装James

```shell
# tar -zxvf james-binary-2.3.2.1.tar.gz
# cd james-2.3.2.1/bin
# chmod +x run.sh phonenix.sh
# sh run.sh
```

出现下面的信息证明启动成功

> Using PHOENIX_HOME:   /home/kris/application/james-2.3.2.1
> Using PHOENIX_TMPDIR: /home/kris/application/james-2.3.2.1/temp
> Using JAVA_HOME:      /home/kris/application/jdk
> Running Phoenix: 
>
> Phoenix 4.2
>
> James Mail Server 2.3.2.1
> Remote Manager Service started plain:4555
> POP3 Service started plain:110
> SMTP Service started plain:25
> NNTP Service started plain:119
> FetchMail Disabled



# 配置James

## 配置config.xml

在下面这个目录, 有config.xml

> /path/to/james-2.3.2.1/apps/james/SAR-INF

找到下面这段东西, 大概在71行, 善用vim搜索

```xml
<!-- 这是原本的 -->
<servernames autodetect="true" autodetectIP="true">
<!-- CONFIRM? -->
  <servername>localhost</servername>
</servernames>

<!-- 改成 -->
<servernames autodetect="false" autodetectIP="false">
<!-- CONFIRM? -->
  <servername>kris.cn</servername>
</servernames>
```



注释下面这段, 大约在913行

这一段的意思是配置局域网广播地址, 目的是只允许这个网段下的终端访问这个邮件服务器

```xml
<!--
  <authorizedAddresses>127.0.0.0/8</authorizedAddresses>
-->
```



查看一下服务器的一些信息

```shell
# cat /etc/resolv.conf
```

> Generated by NetworkManager
> search workgroup
> nameserver 192.168.XXX.XXX
> nameserver 202.116.XXX.XXX



然后在config.xml中查找dnsserver

```xml
<dnsserver>
  <servers>
    <!--Enter ip address of your DNS server, one IP address per server -->
    <!-- element. -->
    <!--
      <server>127.0.0.1</server>
    -->
    <!-- 添加上面那两个IP -->
    <server>192.168.XXX.XXX</server>
    <server>202.116.XXX.XXX</server>
  </servers>
  <!-- Change autodiscover to false if you would like to turn off autodiscovery -->
  <!-- and set the DNS servers manually in the <servers> section -->
  <!-- 这个原本是true的改为false -->
  <autodiscover>false</autodiscover>
  <authoritative>false</authoritative>

  <!-- Maximum number of entries to maintain in the DNS cache -->
  <maxcachesize>50000</maxcachesize>
</dnsserver>
```



在查找`<administrator_accounts>`, 修改管理员的密码

```xml
<administrator_accounts>
<!-- CHECKME! -->
  <!-- Change the default login/password. -->
  <account login="root" password="hijames"/>
</administrator_accounts>
```

保存退出



## 修改服务器host

上面我们改了servername, 所以需要修改一下host, 在/etc/hosts添加下面内容, IP是你服务器的IP, 可以用下面命令查看

```shell
# ifconfig
```

> 127.0.0.1	localhost
> 192.168.156.2	kris.cn			kris



## 优化James配置(可选)

我只是在我的笔记本搭建用来开发, 所有没试过下面的配置

1. 修改james-2.3.2.1/conf/wrapper.conf

```
# Initial Java Heap Size (in MB)
# wrapper.java.initmemory=16
wrapper.java.initmemory=128

# Maximum Java Heap Size (in MB)
# wrapper.java.maxmemory=64
wrapper.java.maxmemory=512
```



2. 修改james-2.3.2.1/bin/phoenix.sh, 添加下面的内容

```shell
PHONEIX_JVM_OPTS="$PHONEIX_JVM_OPTS -Xms128M -Xmx512M"
```

重启一下



# 管理用户

## 开启James

```shell
[root@Debian james-2.3.2.1/bin]# sh run.sh 
```



## 连接James

你需要先有telnet

```shell
# telnet localhost 4555
```

然后输入管理员的帐号密码

> Trying ::1...
> Connected to localhost.
> Escape character is '^]'.
> JAMES Remote Administration Tool 2.3.2.1
> Please enter your login and password
> Login id:
>
> Password:



## 添加用户

输入help查看James的命令

> Welcome root. HELP for a list of commands
> help
> Currently implemented commands:
> help                                    display this help
> listusers                               display existing accounts
> countusers                              display the number of existing accounts
> adduser [username\] [password]           add a new user
> verify [username]                       verify if specified user exist
> deluser [username]                      delete existing user
> setpassword [username\] [password]       sets a user's password
> setalias [user\] [alias]                 locally forwards all email for 'user' to 'alias'
> showalias [username]                    shows a user's current email alias
> unsetalias [user]                       unsets an alias for 'user'
> setforwarding [username\] [emailaddress] forwards a user's email to another email address
> showforwarding [username]               shows a user's current email forwarding
> unsetforwarding [username]              removes a forward
> user [repositoryname]                   change to another user repository
> shutdown                                kills the current JVM (convenient when James is run as a daemon)
> quit                                    close connection

添加一个用户

> adduser kris hikris



# 测试

我用的是Thunderbird测试的, 直接输入帐号密码就可以用了, 这是因为服务器就是我本机

如果你是部署在远程服务器上的, 那你需要配置

- POP服务器的IP(邮件服务器的IP)和端口(默认是110)
- SMTP服务器的IP(邮件服务器的IP)和端口(25)

然后用上面添加的kris用户向qq邮箱发送了一封邮件, 发送成功



[参考文章Linux搭建apache james邮件服务器](http://lib.csdn.net/article/linux/61791)
